{"version":3,"file":"document-setup.bundle.js","sources":["../src/index.js"],"sourcesContent":["import { Tag, Dom, Event } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { BlankSelector } from 'sign.v2.blank-selector';\nimport { Api } from 'sign.v2.api';\nimport './style.css';\nimport type { BlankSelectorConfig } from '../../blank-selector/src/types/config';\n\nexport class DocumentSetup extends EventEmitter\n{\n\tblankSelector: BlankSelector;\n\tsetupData: ?Object;\n\t#layout: HTMLElement;\n\t#api: Api;\n\t#lastBlankId: number;\n\t#uids: Map<number, string>;\n\n\tconstructor(blankSelectorConfig: BlankSelectorConfig)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace('BX.Sign.V2.DocumentSetup');\n\t\tthis.blankSelector = new BlankSelector({\n\t\t\t...blankSelectorConfig,\n\t\t\tevents: {\n\t\t\t\ttoggleSelection: ({ data }) => {\n\t\t\t\t\tthis.emit('toggleSelection', data);\n\t\t\t\t},\n\t\t\t\taddFile: () => this.emit('addFile'),\n\t\t\t\tremoveFile: () => this.emit('removeFile'),\n\t\t\t\tclearFiles: () => this.emit('clearFiles'),\n\t\t\t},\n\t\t});\n\t\tthis.#layout = Tag.render`\n\t\t\t<div class=\"sign-document-setup\">\n\t\t\t\t${this.blankSelector.getLayout()}\n\t\t\t</div>\n\t\t`;\n\t\tthis.#api = new Api();\n\t\tthis.#lastBlankId = 0;\n\t\tthis.#uids = new Map();\n\t\tthis.setupData = null;\n\t}\n\n\tasync #register(blankId: string): Promise<string>\n\t{\n\t\tconst data = await this.#api.register(blankId);\n\n\t\treturn data?.uid ?? '';\n\t}\n\n\tasync #change(uid: string, blankId: number): Promise<string>\n\t{\n\t\tconst data = await this.#api.changeDocument(uid, blankId);\n\n\t\treturn data?.uid ?? '';\n\t}\n\n\tasync #getPages(uid: string): Promise<{url: string;}[]>\n\t{\n\t\tconst data = await this.#api.getPages(uid);\n\n\t\treturn this.#convertToBase64(data?.pages);\n\t}\n\n\tasync #convertToBase64(pages): Promise<string[]>\n\t{\n\t\tif (!pages)\n\t\t{\n\t\t\treturn [];\n\t\t}\n\n\t\tconst promises = pages.map(async (page) => {\n\t\t\tconst data = await fetch(page.url);\n\t\t\tconst blob = await data.blob();\n\t\t\tconst fileReader = new FileReader();\n\t\t\tawait new Promise((resolve) => {\n\t\t\t\tEvent.bindOnce(fileReader, 'loadend', resolve);\n\t\t\t\tfileReader.readAsDataURL(blob);\n\t\t\t});\n\n\t\t\treturn fileReader.result;\n\t\t});\n\n\t\treturn Promise.all(promises);\n\t}\n\n\t#waitForConnect()\n\t{\n\t\tconst observer = new MutationObserver(() => {\n\t\t\tif (!this.#layout.isConnected)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst { blanks, selectedBlankId } = this.blankSelector;\n\t\t\tconst blank = blanks.get(selectedBlankId);\n\t\t\tblank?.focus();\n\t\t\tobserver.disconnect();\n\t\t});\n\t\tobserver.observe(document.body, {\n\t\t\tchildList: true,\n\t\t\tsubtree: true,\n\t\t});\n\t}\n\n\tfinishSetup(setupData, blankId: ?number = 0)\n\t{\n\t\tthis.setupData = setupData;\n\t\tthis.#lastBlankId = blankId;\n\t\tthis.blankSelector.clearFiles({ removeFromServer: false });\n\t}\n\n\trollbackBlank(blankId: number)\n\t{\n\t\tthis.blankSelector.deleteBlank(blankId);\n\t}\n\n\tasync setup()\n\t{\n\t\tconst { selectedBlankId } = this.blankSelector;\n\t\tif (this.#lastBlankId > 0 && this.#lastBlankId === selectedBlankId)\n\t\t{\n\t\t\tthis.setupData = {\n\t\t\t\t...this.setupData,\n\t\t\t\tisTemplate: true\n\t\t\t};\n\n\t\t\treturn this.setupData;\n\t\t}\n\n\t\tlet blankId = 0;\n\n\t\ttry\n\t\t{\n\t\t\tDom.addClass(this.#layout, '--pending');\n\t\t\tblankId = selectedBlankId || await this.blankSelector.createBlank();\n\t\t\tconst isRegistered = this.#uids.has(blankId);\n\t\t\tconst uid = isRegistered\n\t\t\t\t? await this.#change(this.#uids.get(blankId), blankId)\n\t\t\t\t: await this.#register(blankId);\n\t\t\tthis.#uids.set(blankId, uid);\n\t\t\tawait this.#api.upload(uid);\n\t\t\tconst [loadedData, blocks] = await Promise.all([\n\t\t\t\tthis.#api.loadDocument(uid),\n\t\t\t\tthis.loadBlocks(uid)\n\t\t\t]);\n\t\t\tconst isTemplate = !!selectedBlankId;\n\t\t\tthis.finishSetup({ ...loadedData, blocks, isTemplate }, blankId);\n\t\t}\n\t\tcatch\n\t\t{\n\t\t\tthis.finishSetup(null, blankId);\n\t\t\tif (blankId)\n\t\t\t{\n\t\t\t\tthis.rollbackBlank(blankId);\n\t\t\t}\n\t\t}\n\n\t\tDom.removeClass(this.#layout, '--pending');\n\n\t\treturn this.setupData;\n\t}\n\n\tloadBlocks(uid: string)\n\t{\n\t\treturn this.#api.loadBlocksByDocument(uid);\n\t}\n\n\tgetLayout(): HTMLElement\n\t{\n\t\tthis.#waitForConnect();\n\n\t\treturn this.#layout;\n\t}\n\n\tasync waitForPagesList(requestTime: number, cb: Function)\n\t{\n\t\tthis.blankSelector.resetSelectedBlank();\n\t\tconst uid = this.setupData.uid;\n\n\t\tlet promiseResolve = null;\n\t\tlet interval = null;\n\t\tlet isPagesReady = false;\n\n\t\tconst promise = new Promise((resolve) => {\n\t\t\tpromiseResolve = resolve;\n\t\t\tinterval = setInterval(async () => {\n\t\t\t\tif (isPagesReady)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst urls = await this.#getPages(uid);\n\t\t\t\tif (urls.length > 0)\n\t\t\t\t{\n\t\t\t\t\tresolve(urls);\n\t\t\t\t}\n\t\t\t}, requestTime);\n\t\t});\n\n\t\tBX.PULL?.subscribe({\n\t\t\tmoduleId: 'sign',\n\t\t\tcommand: 'blankIsReady',\n\t\t\tcallback: async (result) => {\n\t\t\t\tif (isPagesReady)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst urls = await this.#convertToBase64(result?.pages);\n\t\t\t\tif (urls.length > 0)\n\t\t\t\t{\n\t\t\t\t\tpromiseResolve(urls);\n\t\t\t\t}\n\t\t\t},\n\t\t});\n\n\t\tconst urls = await promise;\n\t\tclearInterval(interval);\n\t\tisPagesReady = true;\n\n\t\tcb(urls);\n\t\tthis.blankSelector.selectBlank(this.#lastBlankId);\n\t}\n}\n"],"names":["DocumentSetup","EventEmitter","constructor","blankSelectorConfig","setEventNamespace","blankSelector","BlankSelector","events","toggleSelection","data","emit","addFile","removeFile","clearFiles","Tag","render","getLayout","Api","Map","setupData","finishSetup","blankId","removeFromServer","rollbackBlank","deleteBlank","setup","selectedBlankId","isTemplate","Dom","addClass","createBlank","isRegistered","has","uid","get","set","upload","loadedData","blocks","Promise","all","loadDocument","loadBlocks","removeClass","loadBlocksByDocument","waitForPagesList","requestTime","cb","resetSelectedBlank","promiseResolve","interval","isPagesReady","promise","resolve","setInterval","urls","length","BX","PULL","subscribe","moduleId","command","callback","result","pages","clearInterval","selectBlank","register","changeDocument","getPages","promises","map","page","fetch","url","blob","fileReader","FileReader","Event","bindOnce","readAsDataURL","observer","MutationObserver","isConnected","blanks","blank","focus","disconnect","observe","document","body","childList","subtree"],"mappings":"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"}