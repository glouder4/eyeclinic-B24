this.BX=this.BX||{};this.BX.Sign=this.BX.Sign||{};(function(e,t,s,i,a){"use strict";let l=e=>e,o,r;const n={entityTypeId:36,guid:"sign_entity_editor",params:{ENABLE_PAGE_TITLE_CONTROLS:false,ENABLE_MODE_TOGGLE:true,IS_EMBEDDED:"N",forceDefaultConfig:"Y",enableSingleSectionCombining:"N"}};const d="company";const c="contact";const b=["onCrmEntityUpdate","BX.Crm.EntityEditor:onFailedValidation","onCrmEntityUpdateError","BX.Crm.EntityEditor:onEntitySaveFailure"];var u=babelHelpers.classPrivateFieldLooseKey("requisitesNode");var v=babelHelpers.classPrivateFieldLooseKey("crmEditorHtml");var p=babelHelpers.classPrivateFieldLooseKey("crmEditor");var y=babelHelpers.classPrivateFieldLooseKey("api");var h=babelHelpers.classPrivateFieldLooseKey("editors");var P=babelHelpers.classPrivateFieldLooseKey("members");var L=babelHelpers.classPrivateFieldLooseKey("loadEntityEditor");var B=babelHelpers.classPrivateFieldLooseKey("showEntityEditor");var m=babelHelpers.classPrivateFieldLooseKey("getMembersData");var E=babelHelpers.classPrivateFieldLooseKey("saveEditor");var I=babelHelpers.classPrivateFieldLooseKey("addMembers");var F=babelHelpers.classPrivateFieldLooseKey("removeMembers");var H=babelHelpers.classPrivateFieldLooseKey("loadMembers");var f=babelHelpers.classPrivateFieldLooseKey("getRequisiteData");var g=babelHelpers.classPrivateFieldLooseKey("toggleCompany");var _=babelHelpers.classPrivateFieldLooseKey("toggleContact");var C=babelHelpers.classPrivateFieldLooseKey("toggleEntity");class w extends s.EventEmitter{constructor(){super();Object.defineProperty(this,C,{value:R});Object.defineProperty(this,_,{value:A});Object.defineProperty(this,g,{value:K});Object.defineProperty(this,f,{value:j});Object.defineProperty(this,H,{value:X});Object.defineProperty(this,F,{value:S});Object.defineProperty(this,I,{value:N});Object.defineProperty(this,E,{value:T});Object.defineProperty(this,m,{value:M});Object.defineProperty(this,B,{value:D});Object.defineProperty(this,L,{value:O});Object.defineProperty(this,u,{writable:true,value:void 0});Object.defineProperty(this,v,{writable:true,value:void 0});Object.defineProperty(this,p,{writable:true,value:void 0});Object.defineProperty(this,y,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:void 0});Object.defineProperty(this,P,{writable:true,value:void 0});this.setEventNamespace("BX.Sign.V2.Requisites");babelHelpers.classPrivateFieldLooseBase(this,u)[u]=t.Tag.render(o||(o=l`
			<div class="sign-wizard__requisites"></div>
		`));babelHelpers.classPrivateFieldLooseBase(this,v)[v]="";babelHelpers.classPrivateFieldLooseBase(this,p)[p]=null;babelHelpers.classPrivateFieldLooseBase(this,y)[y]=new a.Api;this.documentData={};babelHelpers.classPrivateFieldLooseBase(this,P)[P]={};babelHelpers.classPrivateFieldLooseBase(this,h)[h]={}}getLayout(){const e=t.Loc.getMessage("SIGN_PARTY_RESPONSIBLE_TITLE");const s=t.Loc.getMessage("SIGN_PARTY_RESPONSIBLE_HINT");const i=this.documentData.initiator;const a=t.Tag.render(r||(r=l`
			<div class="sign-wizard__preparing">
				<div class="sign-wizard__first-party_responsible">
					<span class="sign-wizard__first-party_responsible-title">
						${0}
						<span data-hint="${0}"></span>
					</span>
					<div class="ui-ctl ui-ctl-textbox sign-wizard__first-party_responsible-name">
						<input
							type="text"
							class="ui-ctl-element"
							value="${0}"
							onchange="${0}"
						/>
					</div>
				</div>
				${0}
			</div>
		`),e,s,t.Text.encode(i),(({target:e})=>{this.emit("changeInitiator",{initiator:e.value})}),babelHelpers.classPrivateFieldLooseBase(this,u)[u]);const o=t.Reflection.getClass("BX.UI.Hint");o.init(a);babelHelpers.classPrivateFieldLooseBase(this,B)[B]();return a}async processMembers(){const e=await babelHelpers.classPrivateFieldLooseBase(this,E)[E]();if(!e){return null}try{const{uid:t=""}=this.documentData;if(!babelHelpers.classPrivateFieldLooseBase(this,P)[P][t]){await babelHelpers.classPrivateFieldLooseBase(this,H)[H](t)}const{MYCOMPANY_ID_INFO:{COMPANY_DATA:[s]},CLIENT_INFO:{CONTACT_DATA:[i]},REQUISITE_BINDING:{REQUISITE_ID:a}}=e;const l=s.id;const o=i.id;const r=babelHelpers.classPrivateFieldLooseBase(this,f)[f](s);const n=babelHelpers.classPrivateFieldLooseBase(this,f)[f](i,a);const d=babelHelpers.classPrivateFieldLooseBase(this,P)[P][t];const c=d==null?void 0:d.filter(((e,t)=>{const s=e.entityId;if(t===0){return s!==l}return s!==o}));const b=babelHelpers.classPrivateFieldLooseBase(this,m)[m](s,i);const u={company:{...b[0],...r,part:1},contact:{...b[1],...n,part:2}};if(d){if(c.length===0){const[e,t]=d;u.company.uid=e.uid;u.contact.uid=t.uid;return u}await babelHelpers.classPrivateFieldLooseBase(this,F)[F](c)}const[v,p]=await babelHelpers.classPrivateFieldLooseBase(this,I)[I](t,{companyPresetId:r.presetId,contactPresetId:n.presetId,companyEntityId:l,contactEntityId:o});u.company.uid=v;u.contact.uid=p;return u}catch{return null}}}async function O(){const e=new i.Loader({target:babelHelpers.classPrivateFieldLooseBase(this,u)[u],size:80});try{var s;e.show();const i=await t.ajax.runAction("crm.api.item.getEditor",{data:{...n,id:this.documentData.entityId}});e.destroy();return(i==null?void 0:(s=i.data)==null?void 0:s.html)||""}catch(t){console.error(t);e.destroy();return""}}async function D(){t.Dom.clean(babelHelpers.classPrivateFieldLooseBase(this,u)[u]);const e=this.documentData.entityId;if(babelHelpers.classPrivateFieldLooseBase(this,h)[h][e]){const t=babelHelpers.classPrivateFieldLooseBase(this,h)[h][e].getContainer();babelHelpers.classPrivateFieldLooseBase(this,u)[u].appendChild(t)}else{const s=await babelHelpers.classPrivateFieldLooseBase(this,L)[L]();await t.Runtime.html(babelHelpers.classPrivateFieldLooseBase(this,u)[u],s);const i=t.Reflection.getClass("BX.Crm.EntityEditor");babelHelpers.classPrivateFieldLooseBase(this,h)[h]={...babelHelpers.classPrivateFieldLooseBase(this,h)[h],[e]:i.defaultInstance}}babelHelpers.classPrivateFieldLooseBase(this,g)[g]();babelHelpers.classPrivateFieldLooseBase(this,_)[_]()}function M(e,t){return[e,t].map((e=>{var t;const{id:s,title:i,url:a,advancedInfo:l,type:o}=e;const r=(t=l==null?void 0:l.multiFields)!=null?t:[];return{id:s,title:i,url:a,type:o,multiFields:r}}))}async function T(){if(!babelHelpers.classPrivateFieldLooseBase(this,h)[h][this.documentData.entityId]){return null}const e=babelHelpers.classPrivateFieldLooseBase(this,h)[h][this.documentData.entityId];const t=e.getControlById("CLIENT");if(t!=null&&t.isInViewMode()&&!t.hasContentToDisplay()){return null}const i=new Promise((e=>{const[t,...i]=b;s.EventEmitter.subscribeOnce(t,(t=>{const[{entityData:s}]=t.data;e(s)}));i.forEach((t=>{s.EventEmitter.subscribeOnce(t,(()=>e(null)))}))}));e.save();const a=await i;b.forEach((e=>s.EventEmitter.unsubscribeAll(e)));return a}async function N(e,t){var s,i,a;const{companyEntityId:l,contactEntityId:o,companyPresetId:r,contactPresetId:n}=t;const b=(s=babelHelpers.classPrivateFieldLooseBase(this,P)[P][e])!=null?s:[];const u=((i=b[0])==null?void 0:i.entityId)===l;const v=((a=b[1])==null?void 0:a.entityId)===o;const p=u?Promise.resolve({uid:b[0].uid}):babelHelpers.classPrivateFieldLooseBase(this,y)[y].addMember(e,d,l,1,r);const h=v?Promise.resolve({uid:b[1].uid}):babelHelpers.classPrivateFieldLooseBase(this,y)[y].addMember(e,c,o,2,n);const[L,B]=await Promise.all([p,h]);babelHelpers.classPrivateFieldLooseBase(this,P)[P]={...babelHelpers.classPrivateFieldLooseBase(this,P)[P],[e]:[{entityId:l,uid:L.uid},{entityId:o,uid:B.uid}]};return[L.uid,B.uid]}async function S(e=[]){await Promise.all([e.map((e=>babelHelpers.classPrivateFieldLooseBase(this,y)[y].removeMember(e.uid)))])}async function X(e){const t=await babelHelpers.classPrivateFieldLooseBase(this,y)[y].loadMembers(e);t.forEach((t=>{var s;babelHelpers.classPrivateFieldLooseBase(this,P)[P][e]=[...(s=babelHelpers.classPrivateFieldLooseBase(this,P)[P][e])!=null?s:[],{entityId:t.entityId,uid:t.uid}]}))}function j(e,t=null){var s;const{requisiteData:i}=e.advancedInfo;const a=(s=i.find((e=>{if(t!==null){return t===e.requisiteId}return e.selected===true})))!=null?s:{};const{entityTypeId:l=0,presetId:o=0}=a;return{entityTypeId:l,presetId:o}}function K(){const e=babelHelpers.classPrivateFieldLooseBase(this,h)[h][this.documentData.entityId];const t=e.getControlById("MYCOMPANY_ID");const s=e.getControlById("myCompany");if(!t){return}babelHelpers.classPrivateFieldLooseBase(this,C)[C](t,s)}function A(){const e=babelHelpers.classPrivateFieldLooseBase(this,h)[h][this.documentData.entityId];const t=e.getControlById("CLIENT");const s=e.getControlById("client");if(!t){return}babelHelpers.classPrivateFieldLooseBase(this,C)[C](t,s)}function R(e,s){const i=e.switchToSingleEditMode;const a=babelHelpers.classPrivateFieldLooseBase(this,h)[h][this.documentData.entityId];e.isRequired=()=>true;e.switchToSingleEditMode=(...t)=>{if((s==null?void 0:s.getMode())===BX.UI.EntityEditorMode.view){a.switchControlMode(s,BX.UI.EntityEditorMode.edit)}i.apply(e,t)};const l=e.layout;e.layout=(...s)=>{l.apply(e,s);t.Dom.remove(e._addContactButton)};const o=e.getId()==="CLIENT"?e.hasContacts():e.hasCompanies();if(o&&(s==null?void 0:s.getMode())===BX.UI.EntityEditorMode.edit){a.switchControlMode(s,BX.UI.EntityEditorMode.view);return}s==null?void 0:s.enableToggling(false);t.Dom.remove(e._addContactButton)}e.Requisites=w})(this.BX.Sign.V2=this.BX.Sign.V2||{},BX,BX.Event,BX,BX.Sign.V2);
//# sourceMappingURL=requisites.bundle.map.js